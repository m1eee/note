## 1.Half-Double与传统Rowhammer对比

|                | **传统Rowhammer**                                            | **Half-Double**                                              |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 原理           | 通过频繁访问某一行（攻击行），使相邻行（受害行）发生比特翻转 | 通过**远距离hammering**+**TRR刷新机制**，使得距离受害行**2行以外**的攻击行也能影响比特翻转 |
| **核心机制**   | 监测高访问行并刷新**相邻行**                                 | 监测攻击行，并随机化地址或扩展 TRR                           |
| **代表性防御** | TRR、ECC、增加刷新频率                                       | (p)TRR±2、攻击者导向防御、物理地址随机化                     |



## 2.Half-Double攻击

### 2.1 攻击原理

Half-Double攻击引入了两种新的Rowhammer模式：

1. **Quad模式（四重模式）**
2. **Weighted模式（加权模式，WS+D，即Weighted Single Plus Decoys）**

#### 2.1.1Quad模式

Quad模式将Double-SidedRowhammer模式向外移动了一行

- F+和F−代表远离受害行的一对远攻击行（far aggressor rows）。

- 这一模式仅对受害行泄漏了少量电荷，因此单独使用Quad模式并不会有效果。

  ![image-20250210125241238](C:\Users\MIE\AppData\Roaming\Typora\typora-user-images\image-20250210125241238.png)

**如何利用TRR机制？**

- 由于TRR机制会检测远攻击行的频繁访问，触发**TRR采样器**（TRR Sampler）。
- 当Rowhammer触发了一定数量的行激活时，**TRR抑制器**（TRR Inhibitor）会向近攻击行（N+，N-）发送刷新命令。
- 由于刷新操作会先关闭当前打开的行，然后激活受影响的行进行刷新，这一额外的行激活有助于Half-Double攻击，使受害行泄漏更多电荷。

#### 2.1.2Weighted模式

Weighted模式的核心思想是：

- 在受害行下方分布多个**诱导行（decoy rows）**，同时将一半的锤击施加到远攻击行（F+）。
- 这一模式可以表示为：

![image-20250210104457558](C:\Users\MIE\AppData\Roaming\Typora\typora-user-images\image-20250210104457558.png)

- RA+x代表物理行的偏移

**作用机制**

- Weighted模式的目标是通过远攻击行的hammering触发TRR机制，使其主动刷新近攻击行。
- 这样会导致近攻击行释放更多电荷，进一步影响受害行。

#### 2.1.3关键假设

**假设H：**

1. 远攻击行（F+，F-）的hammering触发TRR机制，使其刷新近攻击行（N+，N-）。
2. 近攻击行的刷新操作导致受害行（V）泄漏电荷，从而触发比特翻转。
3. 单独的TRR刷新不足以导致受害行比特翻转，必须配合远攻击行的hammering才能成功。



### 2.2Half-Double攻击存在的挑战

#### 2.2.1挑战1：内存分配

- 问题：攻击者需要在DRAM中找到连续的物理内存，但由于现代系统隐藏了物理地址信息，无法直接获得这些地址。

- 解决方案

  1. 研究者使用Buddy分配器（Buddy Allocator）结合DRAM计时旁道（Timing Side Channel）技术来推测物理地址的排列方式。
2. 通过DRAM地址反向工程确定不同物理地址在Bank和Row之间的映射关系。

#### 2.2.2挑战2：如何找到比特翻转

- **问题**：在ECC保护的内存中，单个比特翻转通常会被修复，因此很难找到可利用的比特翻转。

- 解决方案

  1. **Blind-Hammering**：不依赖于预先探测的比特翻转位置，而是通过不断hammering触发比特翻转。
2. **ECC适应性Templating**：传统的Rowhammer攻击使用固定数据模式（如0x55和0xAA）来发现比特翻转。但在ECC保护的内存中，这种方法失效。因此，研究者改进了模板技术，使其适用于ECC保护的环境。

#### 2.2.3挑战3：内存喷射（Memory Spraying）

- **问题**：由于现代ARM设备的地址空间较小，以往的**Page Table Spraying（页表喷射）**技术不再有效。

- 解决方案

  1. 研究者提出了一种新的喷射技术，使得攻击者可以在目标内存区域内填充可利用的数据结构（如PTE，页表条目）。
2. 该方法可以绕过现有的TRR保护，并确保受害行中存在可利用的数据结构。



## 3.TRR在Half-Double攻击中的作用

#### 3.1实验目标

   解决以下问题：

1. Half-Double现象是否仅仅是TRR刷新导致的？
2. 远攻击行（F+，F-）的hammering是否真的会影响到受害行（V）？
3. TRR的受害行刷新是否促进了比特翻转？

#### 3.2实验方法

研究者使用商用SoC平台（带有LPDDR4x内存），以更精确地控制内存刷新，并进行了以下实验：

1. 仅执行距离2的hammering
   
   - 只hammer远攻击行（F+）。
   
     如果Half-Double仅由距离2作用引起，那么此实验应能观察到比特翻转。
   
   - 实验结果：无显著比特翻转，说明Half-Double现象不能仅靠距离2hammering解释。
   
2. 模拟TRR刷新
   - 研究者关闭TRR机制，但手动执行TRR刷新。
   - 实验结果：仍然观察到比特翻转，这说明TRR刷新是Half-Double现象的重要因素。
   
3. 仅执行TRR刷新
   - 研究者不进行hammering，但手动执行TRR刷新。
   - 实验结果：未观察到比特翻转，说明TRR本身并不会引发比特翻转，而必须结合hammering。

#### 3.3实验模式

| 模式   | 描述                                 | 结果       |
| ------ | ------------------------------------ | ---------- |
| **S1** | 只hammer远攻击行（F+）+伪装行（D）   | 无比特翻转 |
| **D1** | hammer远攻击行（F+，F-）             | 无比特翻转 |
| **S2** | hammer远攻击行（F+）+手动TRR刷新     | 有比特翻转 |
| **D2** | hammer远攻击行（F+，F-）+手动TRR刷新 | 有比特翻转 |

#### 3.4结论

- 单独的TRR刷新不会引起比特翻转，但如果结合远攻击行hammering，则可以引发比特翻转。
- TRR机制本身促进了Half-Double现象，因为它的“受害行刷新”会导致更多行被激活，从而引发比特翻转。



## 4.缓解措施：

### 4.1增强TRR机制（(p)TRR±2）

现有的TRR防御主要针对距离1的受害行，但Half-Double利用了距离2的攻击行。

### (1)提出pTRR2：扩展TRR保护范围

- 现有问题：TRR仅会刷攻击行的直接相邻行，但Half-Double可以影响更远的受害行。

- 解决方案：(p)TRR±2机制扩展TRR的受害行刷新范围，使其包括距离2的行，而不仅仅是相邻行。这样可以在攻击者hammer远攻击行（F+，F-）时，主动刷新受害行（V），防止比特翻转。

- 优化策略

  根据受害行距离动态调整刷新频率

  - 距离1的受害行（N+，N-）需要更高频率的刷新。
  - 距离2的受害行（V）可以使用较低的刷新频率，以减少性能开销。

  - 这种优化策略基于Table2的实验结果，即距离2的比特翻转概率低于距离1，但仍然存在。

优点：硬件修改较少：只需调整TRR机制的刷新范围和频率，无需改变DRAM架构。有效应对Half-Double：TRR直接针对Half-Double现象，使其更难成功。

局限性：无法防御未来的Rowhammer变种：如果攻击者找到新的hammering模式（如距离3甚至更远的影响），(p)TRR±2可能仍然无效。
可能增加性能开销：即使降低distance-2行的刷新频率，额外的刷新华操作仍可能影响系统性能。



### 4.2更通用的Rowhammer防御机制

- 现有防御（TRR）的问题
  - 仅会刷新相邻行，不能应对Half-Double这种远程电荷干扰。
- 攻击者导向防御的核心思想
  - 当某行访问次数超过一定阈值时，交换该行的物理地址映射，避免攻击者持续hammer目标行。
  - 具体做法：在同一Bank内使用一个随机排列层（permutation layer），对超出访问阈值的攻击行进行地址交换（rowswapping），从而打破攻击者对相同受害行的持续hammering。

优点：彻底破坏攻击者的hammering规律，让其难以预测物理行地址。适用于未来更高密度的DRAM，增强Rowhammer防御能力。

局限性：需要额外的硬件修改，相比(p)TRR±2更难立即实现。可能影响性能，因为频繁的地址交换可能会影响DRAM访问效率。



### 4.3额外的防御措施（针对具体攻击手法）

### (1)限制连续物理内存分配

- 现有问题：Half-Double需要获得一块连续的物理内存，以便执行hammering攻击。
- 解决方案：修改系统内存分配器，确保不会分配连续的物理页，这样攻击者就必须使用暴力搜索来找到合适的远攻击行，极大降低攻击效率。

### (2)限制vfork系统调用

- 现有问题：vfork()允许进程在创建子进程时共享相同的地址空间，这使得攻击者可以更高效地执行ChildSpray技术（即在多个进程中填充PTE）。
- 解决方案：将vfork()替换为fork()，这样子进程不会继承相同的内存映射，从而破坏攻击者的喷射策略。

